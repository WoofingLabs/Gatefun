<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Gate Fun 一键买入</title>
  <link rel="icon" href="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <style>
    .bg-grid { background-image: url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="1" cy="1" r="1" fill="%230068FF" fill-opacity="0.1"/></svg>'); background-size: 20px 20px; }
    .glow { box-shadow: 0 0 15px rgba(0, 104, 255, 0.5); }
    .float { animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
    .btn-grad { background: linear-gradient(135deg, #0068FF, #18E5A0); }
  </style>
</head>
<body class="bg-[#070808] text-white min-h-screen flex flex-col items-center justify-center p-4">

  <div class="w-full max-w-md">
    <div class="text-center mb-8">
      <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" class="w-24 h-24 mx-auto rounded-full border-4 border-[#18E5A0]/50 glow float" />
      <h1 class="text-4xl font-bold text-[#0068FF] mt-4">Gate Fun 买入</h1>
      <p class="text-gray-400 mt-2">输入代币地址 + 任意 GT 数量</p>
    </div>

    <div class="bg-[#111]/50 p-6 rounded-xl border border-[#0068FF]/30 backdrop-blur">
      <button id="connectBtn" class="w-full py-3 bg-[#0068FF] rounded-full font-medium hover:bg-[#0058CC] transition">
        连接钱包
      </button>
      <p id="status" class="text-sm text-gray-400 text-center mt-2">点击连接 GateLayer</p>

      <div class="mt-4 flex items-center bg-[#111]/80 p-3 rounded-lg border border-[#0068FF]/20">
        <input id="tokenAddr" type="text" placeholder="代币合约地址" class="flex-1 bg-transparent text-white outline-none text-sm" />
        <button onclick="navigator.clipboard.writeText(document.getElementById('tokenAddr').value);document.getElementById('progress').innerText='已复制'" class="text-gray-400 hover:text-[#18E5A0] ml-2"><i class="fa fa-copy"></i></button>
      </div>

      <div class="mt-4">
        <label class="text-sm text-gray-400">GT 买入数量</label>
        <input id="gtAmount" type="text" placeholder="如：0.1 或 100" class="w-full mt-1 px-4 py-2 bg-[#111]/80 border border-[#0068FF]/20 rounded-lg text-white focus:border-[#18E5A0] outline-none" />
      </div>

      <p id="balance" class="text-xs text-gray-500 mt-3">GT 余额: 0</p>

      <button id="buyBtn" disabled class="w-full mt-5 py-3 btn-grad text-white rounded-full font-medium opacity-50 cursor-not-allowed transition">
        请输入代币地址和数量
      </button>

      <p id="progress" class="text-xs text-center mt-3 text-gray-400">等待操作...</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
  <script>
    const PROXY = '0x7c8fbd15e4c8b722920c1570a4704622d5391113';
    const SELECTOR = '0xa59ac6dd';
    let web3, account;

    document.getElementById('connectBtn').onclick = async () => {
      if (!window.ethereum) return alert('请安装 MetaMask');
      web3 = new Web3(window.ethereum);
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        account = (await web3.eth.getAccounts())[0];
        document.getElementById('connectBtn').innerText = `${account.slice(0,6)}...${account.slice(-4)}`;
        document.getElementById('status').innerText = '已连接 GateLayer';
        await switchNetwork();
        updateBalance();
        enableBuy();
        loadTokenFromURL();
      } catch { document.getElementById('progress').innerText = '连接失败'; }
    };

    async function switchNetwork() {
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x2768' }] });
      } catch (e) {
        if (e.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: '0x2768',
              chainName: 'GateLayer',
              rpcUrls: ['https://gatelayer-mainnet.gatenode.cc/'],
              nativeCurrency: { name: 'GT', symbol: 'GT', decimals: 18 },
              blockExplorerUrls: ['https://www.gatescan.org/gatelayer/']
            }]
          });
        }
      }
    }

    async function updateBalance() {
      if (!account) return;
      const bal = await web3.eth.getBalance(account);
      const fmt = Number(web3.utils.fromWei(bal, 'ether')).toFixed(6);
      document.getElementById('balance').innerText = `GT 余额: ${fmt}`;
    }

    function enableBuy() {
      const token = document.getElementById('tokenAddr').value.trim();
      const amount = document.getElementById('gtAmount').value.trim();
      const valid = web3.utils.isAddress(token) && amount && !isNaN(amount) && amount > 0;
      const btn = document.getElementById('buyBtn');
      if (valid && account) {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        btn.innerText = '立即买入';
      } else {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        btn.innerText = '请输入代币地址和数量';
      }
    }

    ['tokenAddr', 'gtAmount'].forEach(id => {
      document.getElementById(id).addEventListener('input', enableBuy);
    });

    document.getElementById('buyBtn').onclick = async () => {
      const token = document.getElementById('tokenAddr').value.trim();
      const amountStr = document.getElementById('gtAmount').value.trim();
      const btn = document.getElementById('buyBtn');

      if (!web3.utils.isAddress(token)) return alert('无效代币地址');
      if (!amountStr || isNaN(amountStr) || parseFloat(amountStr) <= 0) return alert('无效 GT 数量');

      const amountWei = web3.utils.toWei(amountStr, 'ether');

      btn.disabled = true;
      btn.innerHTML = '交易中... <i class="fa fa-spinner fa-spin ml-2"></i>';
      document.getElementById('progress').innerText = '提交交易...';

      try {
        const data = SELECTOR +
          web3.utils.padLeft(token, 64).slice(2) +
          web3.utils.padLeft(amountWei, 64).slice(2) +
          web3.utils.padLeft('0', 64).slice(2) +     // minReceive = 0
          web3.utils.padLeft('0x1f', 64).slice(2);   // flag

        const tx = await web3.eth.sendTransaction({
          from: account,
          to: PROXY,
          value: amountWei,
          data: data,
          gas: 1000000
        });

        document.getElementById('progress').innerHTML = `
          买入成功！<br>
          <a href="https://www.gatescan.org/gatelayer/tx/${tx.transactionHash}" target="_blank" class="text-[#18E5A0] text-xs underline">
            查看交易
          </a>
        `;
      } catch (e) {
        console.error(e);
        let msg = '交易失败';
        if (e.code === 4001) msg = '用户取消';
        else if (e.message.includes('insufficient')) msg = 'GT 余额不足';
        else if (e.data === '0x5a9f5930') msg = '池子已关闭（已迁移到 GateSwap）';
        else if (e.message.includes('reverted')) msg = '合约拒绝：池子无效或已结束';
        document.getElementById('progress').innerText = msg;
      } finally {
        btn.disabled = false;
        btn.innerText = '立即买入';
        setTimeout(updateBalance, 3000);
      }
    };

    function loadTokenFromURL() {
      const params = new URLSearchParams(location.search);
      const token = params.get('token');
      if (token && web3.utils.isAddress(token)) {
        document.getElementById('tokenAddr').value = token;
        enableBuy();
      }
    }

    window.onload = loadTokenFromURL;
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GDOG 查询与领取</title>
    <link rel="icon" type="image/png" href="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0068FF',
                        secondary: '#18E5A0',
                        accent: '#FFD700',
                        dark: '#070808',
                        'light-gray': '#E5E7EB'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        display: ['Changa One', 'system-ui', 'sans-serif']
                    },
                    animation: { 'float': 'float 3s ease-in-out infinite' },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-8px)' }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow-glow { text-shadow: 0 0 10px rgba(0,104,255,0.5); }
            .glow-border { box-shadow: 0 0 12px rgba(24,229,160,0.3); }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Changa+One&display=swap" rel="stylesheet">
</head>
<body class="bg-dark text-white font-sans overflow-x-hidden">

<header class="fixed w-full z-50 bg-dark/90 backdrop-blur-md">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded-full overflow-hidden">
                <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" alt="Logo" class="w-full h-full object-cover">
            </div>
            <span class="font-display text-3xl text-primary text-shadow-glow">GDOG 查询</span>
        </div>
    </div>
</header>

<section class="min-h-screen pt-24 flex items-center justify-center bg-gradient-to-b from-primary/10 to-dark">
    <div class="container mx-auto px-4 text-center">
        <div class="w-48 h-48 mx-auto mb-8 animate-float">
            <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png"
                 alt="GDOG" class="w-full h-full object-cover rounded-full border-4 border-secondary/50 glow-border">
        </div>

        <div class="bg-dark/50 p-8 rounded-lg border border-primary/30 max-w-md mx-auto space-y-6">
            <button id="connectWalletButton"
                    class="w-full px-6 py-3 bg-primary text-white rounded-full font-medium hover:bg-primary/80 transition-all">
                Connect Wallet
            </button>

            <p id="networkStatus" class="text-light-gray text-sm">Click to connect wallet...</p>
            <p id="progressStatus" class="text-light-gray text-sm">Waiting for action...</p>

            <div id="userInfo" class="hidden space-y-4 text-left">
                <div class="flex justify-between">
                    <span class="text-light-gray">已投入 GT</span>
                    <span id="gtSpent" class="font-mono text-secondary">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-light-gray">可领 GDOG</span>
                    <span id="gdogPending" class="font-mono text-secondary">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-light-gray">合约 GDOG 余额</span>
                    <span id="totalGdog" class="font-mono text-secondary">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-light-gray">购买次数</span>
                    <span id="purchases" class="font-mono text-secondary">0</span>
                </div>

                <div id="withdrawSection" class="mt-6">
                    <div id="withdrawStatus" class="p-3 rounded-lg text-center font-medium mb-3">
                        <span id="withdrawText" class="text-red-400">不可领取</span>
                    </div>
                    <button id="withdrawBtn"
                            class="hidden w-full px-6 py-3 bg-secondary text-dark rounded-full font-bold hover:bg-secondary/80 transition-all">
                        领取 GDOG
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
<script>
    // === 完全复用你 HTML 的链配置 ===
    const chains = {
        GateLayer: {
            chainId: 10088,
            chainName: 'Gate Layer',
            rpcUrl: 'https://gatelayer-mainnet.gatenode.cc',
            blockExplorer: 'https://www.gatescan.org/gatelayer/',
            nativeCurrency: { name: 'GT', symbol: 'GT', decimals: 18 }
        }
    };

    const PURCHASE_CONTRACT = '0x9815A071ca9f35837B5bA095Bedc20A5D230DD38';

    const ABI = [
        {
            "inputs": [{"internalType": "address", "name": "user", "type": "address"}],
            "name": "getUserInfo",
            "outputs": [
                {"internalType": "uint256", "name": "gtSpent", "type": "uint256"},
                {"internalType": "uint256", "name": "gdogPending", "type": "uint256"},
                {"internalType": "uint256", "name": "totalGdogBalance", "type": "uint256"},
                {"internalType": "uint256", "name": "purchases", "type": "uint256"}
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "withdrawEnabled",
            "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "withdrawGDOG",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        }
    ];

    let web3, account, contract;

    // === 完全复用你原来的连接函数名和逻辑 ===
    async function initializeWeb3() {
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);  // 先用 MetaMask
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                account = (await web3.eth.getAccounts())[0];
                if (!account) throw new Error('No account');
                document.getElementById('connectWalletButton').innerText = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
                await switchNetwork('GateLayer');
                document.getElementById('networkStatus').innerText = 'Connected to Gate Layer (ID: 10088)';
                contract = new web3.eth.Contract(ABI, PURCHASE_CONTRACT);  // 最后创建合约
                await loadUserInfo();
                setInterval(loadUserInfo, 10000);
            } catch (error) {
                document.getElementById('networkStatus').innerText = 'Wallet connection failed';
                document.getElementById('progressStatus').innerText = `Error: ${error.message}`;
                document.getElementById('connectWalletButton').innerText = 'Connect Wallet';
            }
        } else {
            document.getElementById('networkStatus').innerText = 'Please install MetaMask';
        }
    }

    // === 完全复用你原来的 switchNetwork ===
    async function switchNetwork(chain) {
        const chainConfig = chains[chain];
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: `0x${chainConfig.chainId.toString(16)}` }]
            });
        } catch (switchError) {
            if (switchError.code === 4902) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: `0x${chainConfig.chainId.toString(16)}`,
                        chainName: chainConfig.chainName,
                        rpcUrls: [chainConfig.rpcUrl],
                        nativeCurrency: chainConfig.nativeCurrency,
                        blockExplorerUrls: [chainConfig.blockExplorer]
                    }]
                });
            } else {
                throw switchError;
            }
        }
    }

    // 查询
    async function loadUserInfo() {
        if (!account || !contract) return;
        try {
            const [gt, pending, total, purchases] = await contract.methods.getUserInfo(account).call();
            const enabled = await contract.methods.withdrawEnabled().call();

            const fmt = n => Number(web3.utils.fromWei(n, 'ether')).toFixed(18).replace(/\.?0+$/, '');

            document.getElementById('gtSpent').innerText = fmt(gt);
            document.getElementById('gdogPending').innerText = fmt(pending);
            document.getElementById('totalGdog').innerText = fmt(total);
            document.getElementById('purchases').innerText = purchases;

            const canWithdraw = enabled && Number(pending) > 0;
            const statusEl = document.getElementById('withdrawText');
            const btn = document.getElementById('withdrawBtn');

            if (canWithdraw) {
                statusEl.textContent = '可领取';
                statusEl.className = 'text-green-400';
                btn.classList.remove('hidden');
                btn.onclick = withdrawGDOG;
            } else {
                statusEl.textContent = enabled ? '无可领 GDOG' : '未开放领取';
                statusEl.className = 'text-red-400';
                btn.classList.add('hidden');
            }

            document.getElementById('userInfo').classList.remove('hidden');
            updateStatus('数据已更新');
        } catch (err) {
            console.error(err);
            updateStatus('查询失败，3秒后重试...', 'error');
            setTimeout(loadUserInfo, 3000);
        }
    }

    async function withdrawGDOG() {
        const btn = document.getElementById('withdrawBtn');
        btn.disabled = true;
        btn.innerHTML = '领取中... <i class="fa fa-spinner fa-spin ml-2"></i>';
        try {
            const tx = await contract.methods.withdrawGDOG().send({ from: account });
            updateStatus(`领取成功！Tx: ${tx.transactionHash.slice(0,10)}...`);
            await loadUserInfo();
        } catch (err) {
            updateStatus('领取失败：' + (err.message || '拒绝'), 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '领取 GDOG';
        }
    }

    function updateStatus(msg, type = 'info') {
        const el = document.getElementById('progressStatus');
        el.textContent = msg;
        el.className = type === 'error' ? 'text-red-400 text-sm' : 'text-light-gray text-sm';
    }

    // === 完全复用你原来的绑定方式 ===
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('connectWalletButton').addEventListener('click', initializeWeb3);
    });
</script>
</body>
</html>
